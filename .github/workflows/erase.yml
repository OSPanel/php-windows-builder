name: Erase All Runs and Artifacts

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type YES to delete ALL artifacts and workflow runs"
        required: true
        default: "NO"

permissions:
  actions: write
  contents: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  erase:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'YES' }}
    steps:
      - name: Install gh and jq
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y curl
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /usr/share/keyrings/githubcli-archive-keyring.gpg >/dev/null
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
              | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Authenticate gh
        shell: bash
        run: |
          set -euo pipefail
          printf "%s" "${GITHUB_TOKEN}" | gh auth login --with-token
          gh auth status

      - name: Delete all artifacts (paged)
        shell: bash
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Deleting artifacts in ${REPO}..."
          page=1
          while true; do
            resp="$(gh api -H 'Accept: application/vnd.github+json' "/repos/${REPO}/actions/artifacts?per_page=100&page=${page}")" || break
            count="$(echo "$resp" | jq '.artifacts | length')"
            if [ "$count" -eq 0 ]; then
              break
            fi
            echo "$resp" | jq -r '.artifacts[].id' | while read -r id; do
              [ -z "$id" ] && continue
              echo "Deleting artifact ID: $id"
              gh api --method DELETE -H 'Accept: application/vnd.github+json' "/repos/${REPO}/actions/artifacts/${id}" || true
            done
            page=$((page+1))
          done
          echo "Artifacts deletion finished."

      - name: Delete all workflow runs (paged)
        shell: bash
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Deleting workflow runs in ${REPO}..."
          page=1
          while true; do
            resp="$(gh api -H 'Accept: application/vnd.github+json' "/repos/${REPO}/actions/runs?per_page=100&page=${page}")" || break
            count="$(echo "$resp" | jq '.workflow_runs | length')"
            if [ "$count" -eq 0 ]; then
              break
            fi
            echo "$resp" | jq -r '.workflow_runs[].id' | while read -r id; do
              [ -z "$id" ] && continue
              echo "Deleting workflow run ID: $id"
              gh api --method DELETE -H 'Accept: application/vnd.github+json' "/repos/${REPO}/actions/runs/${id}" || true
            done
            page=$((page+1))
          done
          echo "Workflow runs deletion finished."

      - name: Done
        shell: bash
        run: echo "Done: all artifacts and workflow runs have been deleted."