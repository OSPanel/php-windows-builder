name: ğŸ—‘ï¸ Delete All Runs and Artifacts

on:
  workflow_dispatch:

jobs:
  delete-all:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›¡ï¸ Checkout repository
        uses: actions/checkout@v5

      - name: ğŸ”§ Setup GitHub CLI and authenticate
        run: |
          # Check GitHub CLI version
          gh --version

          # GitHub CLI automatically uses GITHUB_TOKEN from environment
          # Verify authentication
          gh auth status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ›‘ Cancel all running workflow runs (except current)
        run: |
          echo "ğŸ›‘ Cancelling all running workflow runs (except current)..."

          # Get all running workflow runs (excluding current one)
          current_run_id="${{ github.run_id }}"
          running_runs=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq ".workflow_runs[] | select(.status == \"in_progress\" or .status == \"queued\") | select(.id != $current_run_id) | .id" \
            2>/dev/null || echo "")

          if [ -z "$running_runs" ]; then
            echo "ğŸƒ No running workflow runs found (except current one)."
          else
            run_count=$(echo "$running_runs" | wc -l)
            echo "ğŸƒ Found $run_count running workflow runs to cancel"

            counter=0
            for run_id in $running_runs; do
              counter=$((counter + 1))
              echo "ğŸ›‘ [$counter/$run_count] Cancelling workflow run ID: $run_id"
              # Using --force flag from GitHub CLI 2.78.0
              if gh run cancel $run_id --force >/dev/null 2>&1; then
                echo "âœ… Workflow run $run_id cancelled"
              else
                echo "âŒ Failed to cancel workflow run $run_id"
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â³ Wait for cancellations to complete
        run: |
          echo "â³ Waiting 30 seconds for cancellations to complete..."
          sleep 30

      - name: ğŸ—‘ï¸ Delete all artifacts and workflow runs (with retries)
        run: |
          echo "âš ï¸ Starting complete cleanup for repository ${{ github.repository }}..."
          echo "â„¹ï¸ Current run (${{ github.run_id }}) will be preserved and NOT deleted"

          cycle=1
          while true; do
            echo ""
            echo "ğŸ”„ Cleanup cycle $cycle"
            echo "===================="

            # Delete all artifacts
            echo "ğŸ—‘ï¸ Deleting artifacts..."
            artifact_ids=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq '.artifacts[].id' 2>/dev/null || echo "")

            if [ -z "$artifact_ids" ]; then
              echo "ğŸ“¦ No artifacts found."
              artifacts_deleted=false
            else
              artifact_count=$(echo "$artifact_ids" | wc -l)
              echo "ğŸ“¦ Found $artifact_count artifacts to delete"
              artifacts_deleted=true

              counter=0
              for artifact_id in $artifact_ids; do
                counter=$((counter + 1))
                echo "ğŸ—‘ï¸ [$counter/$artifact_count] Deleting artifact ID: $artifact_id"
                if gh api --method DELETE "repos/${{ github.repository }}/actions/artifacts/$artifact_id" >/dev/null 2>&1; then
                  echo "âœ… Artifact $artifact_id deleted"
                else
                  echo "âŒ Failed to delete artifact $artifact_id (may have expired)"
                fi
              done
            fi

            # Delete all workflow runs except current one
            echo "ğŸ—‘ï¸ Deleting workflow runs..."
            current_run_id="${{ github.run_id }}"
            run_ids=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq ".workflow_runs[] | select(.id != $current_run_id) | .id" 2>/dev/null || echo "")

            if [ -z "$run_ids" ]; then
              echo "ğŸƒ No workflow runs found to delete (except current one)."
              runs_deleted=false
            else
              run_count=$(echo "$run_ids" | wc -l)
              echo "ğŸƒ Found $run_count workflow runs to delete"
              runs_deleted=true

              counter=0
              for run_id in $run_ids; do
                counter=$((counter + 1))
                echo "ğŸ—‘ï¸ [$counter/$run_count] Deleting workflow run ID: $run_id"
                if gh api --method DELETE "repos/${{ github.repository }}/actions/runs/$run_id" >/dev/null 2>&1; then
                  echo "âœ… Workflow run $run_id deleted"
                else
                  echo "âŒ Failed to delete workflow run $run_id"
                fi
              done
            fi

            # Check if we need to continue
            if [ "$artifacts_deleted" = false ] && [ "$runs_deleted" = false ]; then
              echo ""
              echo "ğŸ¯ No more items to delete. Cleanup completed!"
              break
            else
              echo ""
              echo "ğŸ”„ Items found and deleted. Checking for more..."
              cycle=$((cycle + 1))
              sleep 5  # Brief pause between cycles
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ Final cleanup verification
        run: |
          echo "ğŸ” Verifying cleanup results..."

          # Check remaining artifacts
          remaining_artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq '.total_count' 2>/dev/null || echo "0")
          echo "ğŸ“¦ Remaining artifacts: $remaining_artifacts"

          # Check remaining runs (should be 1 - current run)
          total_runs=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.total_count' 2>/dev/null || echo "0")
          remaining_runs=$((total_runs - 1))

          echo "ğŸƒ Total workflow runs: $total_runs"
          echo "ğŸƒ Other workflow runs (excluding current): $remaining_runs"
          echo "ğŸ›¡ï¸ Current run (${{ github.run_id }}) preserved"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Cleanup completed successfully
        run: |
          echo "ğŸ‰ Cleanup completed successfully!"
          echo "ğŸ“Š Repository: ${{ github.repository }}"
          echo "â° Completion time: $(date)"
          echo "ğŸ”§ GitHub CLI version: $(gh --version | head -n1)"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "  âœ… All artifacts deleted"
          echo "  âœ… All workflow runs deleted (except current)"
          echo "  ğŸ›¡ï¸ Current workflow run preserved"
          echo "  ğŸ†” Current run ID: ${{ github.run_id }}"
          echo ""
          echo "â„¹ï¸ This workflow run will remain in the history for reference"
          
