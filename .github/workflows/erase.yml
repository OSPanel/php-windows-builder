name: Delete All

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm deletion of ALL runs and artifacts'
        required: true
        default: ''

jobs:
  delete-all:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE'

    steps:
      - name: ğŸ›¡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup GitHub CLI and authenticate
        run: |
          # Check GitHub CLI availability
          gh --version

          # Authenticate with token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          # Verify authentication
          gh auth status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—‘ï¸ Delete all artifacts
        run: |
          echo "âš ï¸ Deleting all artifacts for repository ${{ github.repository }}..."

          # Get all artifacts and delete them
          artifact_ids=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[].id' 2>/dev/null || echo "")

          if [ -z "$artifact_ids" ]; then
            echo "ğŸ“¦ No artifacts found."
          else
            artifact_count=$(echo "$artifact_ids" | wc -l)
            echo "ğŸ“¦ Found $artifact_count artifacts to delete"

            counter=0
            for artifact_id in $artifact_ids; do
              counter=$((counter + 1))
              echo "ğŸ—‘ï¸ [$counter/$artifact_count] Deleting artifact ID: $artifact_id"
              if gh api --method DELETE "repos/${{ github.repository }}/actions/artifacts/$artifact_id" >/dev/null 2>&1; then
                echo "âœ… Artifact $artifact_id deleted"
              else
                echo "âŒ Failed to delete artifact $artifact_id"
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—‘ï¸ Delete all workflow runs
        run: |
          echo "âš ï¸ Deleting all workflow runs for repository ${{ github.repository }}..."

          # Get all workflow runs and delete them (excluding current run)
          current_run_id="${{ github.run_id }}"
          run_ids=$(gh api repos/${{ github.repository }}/actions/runs --jq ".workflow_runs[] | select(.id != $current_run_id) | .id" 2>/dev/null || echo "")

          if [ -z "$run_ids" ]; then
            echo "ğŸƒ No workflow runs found (except current one)."
          else
            run_count=$(echo "$run_ids" | wc -l)
            echo "ğŸƒ Found $run_count workflow runs to delete"

            counter=0
            for run_id in $run_ids; do
              counter=$((counter + 1))
              echo "ğŸ—‘ï¸ [$counter/$run_count] Deleting workflow run ID: $run_id"
              if gh api --method DELETE "repos/${{ github.repository }}/actions/runs/$run_id" >/dev/null 2>&1; then
                echo "âœ… Workflow run $run_id deleted"
              else
                echo "âŒ Failed to delete workflow run $run_id"
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ Final cleanup verification
        run: |
          echo "ğŸ” Verifying cleanup results..."

          # Check remaining artifacts
          remaining_artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.total_count' 2>/dev/null || echo "0")
          echo "ğŸ“¦ Remaining artifacts: $remaining_artifacts"

          # Check remaining runs (excluding current one)
          current_run_id="${{ github.run_id }}"
          remaining_runs=$(gh api repos/${{ github.repository }}/actions/runs --jq ".total_count - 1" 2>/dev/null || echo "0")
          echo "ğŸƒ Remaining workflow runs (except current): $remaining_runs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Cleanup completed
        run: |
          echo "ğŸ‰ Cleanup completed successfully!"
          echo "ğŸ“Š Repository: ${{ github.repository }}"
          echo "â° Completion time: $(date)"
          echo "â„¹ï¸ Current run (${{ github.run_id }}) will be deleted automatically after completion"

  cancel-action:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'DELETE'

    steps:
      - name: âŒ Action cancelled
        run: |
          echo "âŒ Action cancelled!"
          echo "ğŸ”’ To confirm deletion, type 'DELETE' in the confirm field."
          echo "âš ï¸ This action will delete ALL artifacts and workflow runs in the repository!"
          echo "ğŸ“Š Repository: ${{ github.repository }}"
          exit 1