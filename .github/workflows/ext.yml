name: Build PHP Extensions Packs
run-name: Build PHP Ext Packs ${{ inputs.php-versions || 'all-in-matrix' }}

on:
  workflow_dispatch:
    inputs:
      php-versions:
        description: 'Which PHP versions to build (comma-separated), e.g.: 7.2,7.4,8.1,8.3. Default: all found in matrix.json'
        required: false
      ts:
        description: 'Build types: ts, nts or ts,nts'
        required: false
        default: 'ts,nts'
      upload:
        description: 'Upload to release (true/false)'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  generate-matrix:
    name: Generate matrix from matrix.json
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: mk-matrix
        shell: bash
        run: |
          set -euo pipefail

          PHP_VERSIONS_INPUT="${{ inputs.php-versions || '' }}"
          TS_INPUT="${{ inputs.ts || 'ts,nts' }}"

          ALL_PHP_VERS=$(
            jq -r '
              to_entries
              | map(.value.ver | keys[])
              | unique
              | .[]
            ' extension/BuildPhpExtension/config/matrix.json
          )

          if [[ -n "$PHP_VERSIONS_INPUT" ]]; then
            IFS=',' read -ra REQ <<< "$PHP_VERSIONS_INPUT"
            PHP_VERS=()
            for v in "${REQ[@]}"; do
              v_trim=$(echo "$v" | xargs)
              if printf '%s\n' "${ALL_PHP_VERS[@]}" | grep -qx "$v_trim"; then
                PHP_VERS+=("$v_trim")
              else
                echo "Warning: PHP version $v_trim not found in matrix.json — skipped" >&2
              fi
            done
          else
            PHP_VERS=(${ALL_PHP_VERS})
          fi

          if [[ ${#PHP_VERS[@]} -eq 0 ]]; then
            echo "No PHP versions found to build" >&2
            exit 1
          fi

          IFS=',' read -ra TS_VALUES <<< "$TS_INPUT"

          MATRIX_JSON='{"include":['
          SEP=""
          for phpv in "${PHP_VERS[@]}"; do
            for ts in "${TS_VALUES[@]}"; do
              MATRIX_JSON+="${SEP}{\"php\":\"${phpv}\",\"ts\":\"${ts}\"}"
              SEP=","
            done
          done
          MATRIX_JSON+="]}"

          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

  build-and-release:
    name: Build + Release ${{ matrix.php }}-${{ matrix.ts }}
    runs-on: windows-2022
    needs: generate-matrix
    if: ${{ always() }} # allow parallel independent releases
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine toolset and naming
        id: toolset
        shell: bash
        run: |
          set -euo pipefail
          PHP="${{ matrix.php }}"
          TS="${{ matrix.ts }}"

          # Compiler map:
          # 7.x => vc15
          # 8.0–8.3 => vs16
          # 8.4–8.5 => vs17
          major="${PHP%%.*}"
          minor="${PHP#*.}"

          tool=""
          if [[ "$major" == "7" ]]; then
            tool="vc15"
          else
            if [[ "$minor" -ge 4 ]]; then
              tool="vs17"
            else
              tool="vs16"
            fi
          fi

          TARGET_DIR="php-${PHP}-${TS}"
          echo "tool=$tool" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET_DIR" >> "$GITHUB_OUTPUT"

      - name: Create target directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ steps.toolset.outputs.target }}" | Out-Null

      - name: Build download plan from matrix.json
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          PHP="${{ matrix.php }}"
          TS="${{ matrix.ts }}"
          TOOL="${{ steps.toolset.outputs.tool }}"

          DOWNLOADS=$(jq -r --arg php "$PHP" '
            to_entries
            | map({
                ext: .key,
                ver: (.value.ver[$php] // "")
              })
            | map(select(.ver != ""))[]
            | @json
          ' extension/BuildPhpExtension/config/matrix.json)

          PLAN_JSON='[]'
          while IFS= read -r row; do
            ext=$(echo "$row" | jq -r '.ext')
            ver=$(echo "$row" | jq -r '.ver')
            tag="${ext}-${ver}"
            file="php_${ext}-${ver}-${PHP}-${TS}-${TOOL}-x64.zip"
            url="https://github.com/OSPanel/php-windows-builder/releases/download/${tag}/${file}"
            PLAN_JSON=$(echo "$PLAN_JSON" | jq --arg url "$url" --arg file "$file" '. + [{url:$url,file:$file}]')
          done <<< "$DOWNLOADS"

          echo "plan=$PLAN_JSON" >> "$GITHUB_OUTPUT"

      - name: Download all extension archives
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $target = "${{ steps.toolset.outputs.target }}"
          $plan = '${{ steps.plan.outputs.plan }}' | ConvertFrom-Json
          if (-not (Test-Path $target)) { New-Item -ItemType Directory -Path $target | Out-Null }

          foreach ($item in $plan) {
            $url = $item.url
            $file = Join-Path $target $item.file
            Write-Host "Downloading $url -> $file"
            try {
              Invoke-WebRequest -Uri $url -OutFile $file -UseBasicParsing
            } catch {
              Write-Warning "Failed to download $url"
              throw
            }
          }

      - name: Extract all archives and remove zips
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $target = "${{ steps.toolset.outputs.target }}"
          Get-ChildItem -Path $target -Filter *.zip | ForEach-Object {
            Write-Host "Unzip: $($_.FullName)"
            Expand-Archive -LiteralPath $_.FullName -DestinationPath $target -Force
          }
          Get-ChildItem -Path $target -Filter *.zip | Remove-Item -Force

      - name: Pack result
        id: pack
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $php = "${{ matrix.php }}"
          $ts  = "${{ matrix.ts }}"
          $tool = "${{ steps.toolset.outputs.tool }}"
          $target = "${{ steps.toolset.outputs.target }}"

          # Archive name: php-ext-pack-<php>-<ts>-Win32-<tool>-x64.zip
          $zipName = "php-ext-pack-$php-$ts-Win32-$tool-x64.zip"

          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path (Join-Path $target '*') -DestinationPath $zipName

          Write-Output "zip=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Upload single-file release
        if: ${{ inputs.upload == 'true' }}
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PHP="${{ matrix.php }}"
          TS="${{ matrix.ts }}"
          ZIP="${{ steps.pack.outputs.zip }}"

          # Release tag per pack: ext-pack-<MAJOR.MINOR>-<ts>
          TAG="ext-pack-${PHP}-${TS}"
          TITLE="Extensions Pack for PHP ${PHP} (${TS})"
          BODY="PHP extensions pack built from matrix.json for PHP ${PHP} (${TS})."

          # Create or update the release with a single artifact
          if ! gh release view "$TAG" -R "${{ github.repository }}" >/dev/null 2>&1; then
            gh release create "$TAG" "$ZIP" \
              -t "$TITLE" \
              -n "$BODY" \
              -R "${{ github.repository }}"
          else
            # Replace the asset if it exists
            gh release upload "$TAG" "$ZIP" --clobber -R "${{ github.repository }}"
          fi