name: Check PECL versions

on:
  workflow_dispatch: # Ð·Ð°Ð¿ÑƒÑÐº Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ

jobs:
  check:
    runs-on: windows-2022

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run PECL check
        shell: pwsh
        run: |
          Write-Host "=== Ð§Ñ‚ÐµÐ½Ð¸Ðµ matrix.json ==="
          $j = Get-Content "extension/BuildPhpExtension/config/matrix.json" | ConvertFrom-Json

          function Normalize-Version($v) {
              if (-not $v -or $v -notmatch '^\d') { return $null }
              $v = $v -replace '[^0-9\.]', ''
              try { return [version]$v } catch { return $null }
          }

          foreach ($ext in $j.PSObject.Properties.Name) {
              $matrixVersions = $j.$ext.ver.PSObject.Properties.Value `
                  | ForEach-Object { Normalize-Version $_ } `
                  | Where-Object { $_ }

              if (-not $matrixVersions) { continue }

              $matrixMax = ($matrixVersions | Sort-Object -Descending)[0]

              try {
                  $peclRaw = Invoke-RestMethod https://pecl.php.net/rest/r/$ext/latest.txt
                  if ($peclRaw -match 'RC|beta|alpha') { continue }

                  $peclVer = Normalize-Version $peclRaw

                  # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¸Ð½Ñ„Ñƒ Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ Ð²ÐµÑ€ÑÐ¸Ñ Ð² pecl Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡ÐµÐ¼ Ð² Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ðµ
                  if ($peclVer -and $peclVer -gt $matrixMax) {
                      Write-Host "ðŸ”„ $ext => Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° $matrixMax < pecl $peclVer"
                  }
              } catch {
                  Write-Warning "âš ï¸ $ext Ð½ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² PECL"
              }
          }
